@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-10 mx-auto">
            <h2 class="mb-4">Ask Questions About Your Data</h2>
            
            <div class="card mb-4">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Your Question:</label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               @bind="questionInput" 
                               @bind:event="oninput"
                               @onkeypress="HandleKeyPress"
                               placeholder="e.g., How many orders in the last 7 days?" />
                    </div>
                    
                    <button class="btn btn-primary btn-lg" 
                            @onclick="SendQuery" 
                            disabled="@(!IsConnected || isProcessing)">
                        @if (isProcessing)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Processing...</span>
                        }
                        else
                        {
                            <span>Ask Question</span>
                        }
                    </button>

                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert alert-info mt-3" role="alert">
                            <i class="bi bi-info-circle me-2"></i>@statusMessage
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger mt-3" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>@errorMessage
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(generatedSql))
            {
                <div class="card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Generated SQL Query</h5>
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3 rounded"><code>@generatedSql</code></pre>
                    </div>
                </div>
            }

            @if (queryResults.Any())
            {
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        @foreach (var key in queryResults[0].Keys)
                                        {
                                            <th>@key</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var row in queryResults)
                                    {
                                        <tr>
                                            @foreach (var value in row.Values)
                                            {
                                                <td>@value</td>
                                            }
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <p class="text-muted mt-2">@queryResults.Count row(s) returned</p>
                    </div>
                </div>
            }

            <div class="card mt-4 bg-light">
                <div class="card-body">
                    <h6 class="fw-bold">Example Questions:</h6>
                    <ul class="mb-0">
                        <li>How many orders in the last 7 days?</li>
                        <li>What is the total sales amount this month?</li>
                        <li>Show me all pending orders</li>
                        <li>What is the average order value?</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private HubConnection? hubConnection;
    private string questionInput = "";
    private string statusMessage = "";
    private string errorMessage = "";
    private string generatedSql = "";
    private bool isProcessing = false;
    private List<Dictionary<string, object>> queryResults = new();

    protected override async Task OnInitializedAsync()
    {
        // Configure SignalR connection
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("https://localhost:7166/queryhub"))
            .WithAutomaticReconnect()
            .Build();

        // Register event handlers
        hubConnection.On<string>("ReceiveStatus", (status) =>
        {
            statusMessage = status;
            errorMessage = "";
            StateHasChanged();
        });

        hubConnection.On<string>("ReceiveSqlQuery", (sql) =>
        {
            generatedSql = sql;
            StateHasChanged();
        });

        hubConnection.On<List<Dictionary<string, object>>>("ReceiveResults", (results) =>
        {
            queryResults = results;
            isProcessing = false;
            StateHasChanged();
        });

        hubConnection.On<string>("ReceiveError", (error) =>
        {
            errorMessage = error;
            statusMessage = "";
            isProcessing = false;
            StateHasChanged();
        });

        // Start connection
        try
        {
            await hubConnection.StartAsync();
            statusMessage = "Connected to server";
        }
        catch (Exception ex)
        {
            errorMessage = $"Connection failed: {ex.Message}";
        }
    }

    private async Task SendQuery()
    {
        if (string.IsNullOrWhiteSpace(questionInput))
            return;

        isProcessing = true;
        errorMessage = "";
        generatedSql = "";
        queryResults.Clear();

        try
        {
            await hubConnection!.InvokeAsync("ProcessNaturalLanguageQuery", questionInput);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error sending query: {ex.Message}";
            isProcessing = false;
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && IsConnected && !isProcessing)
        {
            await SendQuery();
        }
    }

    public bool IsConnected => hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}